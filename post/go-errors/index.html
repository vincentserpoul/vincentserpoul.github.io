<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>golang errors (after 1.13) | VS tech corner</title>
<meta name="keywords" content="golang, errors">
<meta name="description" content="golang errors (after 1.13)">
<meta name="author" content="Me">
<link rel="canonical" href="https://vincentserpoul.github.io/post/go-errors/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css" integrity="sha256-7I2jZsovtkdTfMt6j2&#43;ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js" integrity="sha256-uVus3DnjejMqn4g7Hni&#43;Srwf3KK8HyZB9V4809q9TWE="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://vincentserpoul.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://vincentserpoul.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://vincentserpoul.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://vincentserpoul.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://vincentserpoul.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-81802018-1', 'auto');
	
	ga('send', 'pageview');
}
</script><meta property="og:title" content="golang errors (after 1.13)" />
<meta property="og:description" content="golang errors (after 1.13)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://vincentserpoul.github.io/post/go-errors/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-05-17T12:30:48&#43;08:00" />
<meta property="article:modified_time" content="2021-05-17T12:30:48&#43;08:00" /><meta property="og:site_name" content="Vincent Serpoul" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="golang errors (after 1.13)"/>
<meta name="twitter:description" content="golang errors (after 1.13)"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://vincentserpoul.github.io/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "golang errors (after 1.13)",
      "item": "https://vincentserpoul.github.io/post/go-errors/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "golang errors (after 1.13)",
  "name": "golang errors (after 1.13)",
  "description": "golang errors (after 1.13)",
  "keywords": [
    "golang", "errors"
  ],
  "articleBody": "Since go 1.13, go has gone one step further in terms of error handling. Errors can be wrapped, bubbled up and act upon.\nWe will here take a step back on error handling in go, from the perspective of a library.\nWhat data could we have in the error? Inspired by a rust talk from Jan Lusby about errors, here are a few things that error could contain:\nThe reason of the error Context of the error: struct field, struct surrounding values… Stack trace: which part of the code triggered this error How to fix the error: suggest a way to fix it Where are errors displayed? In the logs of an application In front of the end user Ways to define errors after golang 1.13 a) inline, with no type definition return fmt.Errorf(\"bad int %d\", i) (+)\nsimple to write no runtime penalty (-)\nimpossible to handle properly as you can’t match and react accordingly b) sentinel errors var errBadInt = errors.New(\"bad int\") return fmt.Errorf(\"%w %d\", i) (+)\nmatch on error possible (-)\nruntime (init) penalty binary size penalty global vars (fragile) c) structs, with defined context and string formatting type errBadInt struct { i int } func (e *errBadInt) Error() string { return fmt.Errorf(\"bad int: %d\", i) } func newErrBadInt(i int) *errBadInt { return \u0026errBadInt{i} } More tricks used by libs out there upspin by Rob Pike himself smart use of const and redefine the Error struct with context return stack in debug mode big cache interesting usage of const + error interface to avoid global vars So what should we do? For simple errors Keep the errors as they are, but turn them into const thanks to the bigcache trick. It keeps the nice opportunity to use errors.Is and removes the initialization cost. No wrapping when there is no additional context. Context is not stack trace. Externally available errors should be handling all errors, unwrap them and repackage them again.\ntype marshalError string func (me marshalError) Error() string { return string(me) } const ErrBadInt = marshalError(\"bad int\") func testErr() error { return fmt.Errorf(\"%w\", ErrBadInt) } For more complex errors type badValueError struct { key string value interface{} } func (bv *badValueError) Error() string { return fmt.Sprintf(\"bad value %v for key %s\", bv.value, bv.key) } func testErr() error { v := 3 k := \"test\" return badValueError{key: k, value: v} } Handling errors Error as values testable in the playground\npackage main import ( \"errors\" \"fmt\" \"log\" ) type marshalError string func (me marshalError) Error() string { return string(me) } const errBadInt = marshalError(\"bad int\") func testErr() error { return fmt.Errorf(\"%w\", errBadInt) } func main() { err := testErr() if errors.Is(err, errBadInt) { log.Printf(\"%v\", err) } else { log.Println(\"wrong\") } var e marshalError if errors.As(err, \u0026e) { log.Printf(\"%v\", err) } else { log.Println(\"wrong\") } } Error as struct on the playground\npackage main import ( \"errors\" \"fmt\" \"log\" ) type badValueError struct { key string value interface{} } func (bv *badValueError) Error() string { return fmt.Sprintf(\"bad value %v for key %s\", bv.value, bv.key) } func testErr() error { v := 3 k := \"test\" return \u0026badValueError{key: k, value: v} } func main() { err := testErr() var e *badValueError if errors.As(err, \u0026e) { log.Printf(\"%v\", err) } else { log.Println(\"wrong\") } } Further thoughts Panic or not panic? I tend to agree with uber recommendation to not panic in a library, especially when you’re expected to most likely handle user data. It allows the user of the lib to do whatever they want with the returned error.\nThat said, it’s important to actually notify the library user if the library is used improperly in cases that are supposedly “not possible” by panicking. The lib user is always able to handle these panics through a recover.\nWrapping or not wrapping? from go1.13 post on errors:\n\"wrapping an error makes that error part of your API. If you don't want to commit to supporting that error as part of your API in the future, you shouldn't wrap the error.\" It also makes no sense to wrap unexported errors to the external user of the API, as the user has no way of testing/matching the error. External methods hence should not return internal errors and return their own exported type, catered at the lib user.\nSee what wrapping allow and not allow you to do:\npackage main import ( \"errors\" \"fmt\" ) type AlphaError struct { err error ratio int } func (e *AlphaError) Error() string { return fmt.Sprintf(\"%v %d\", e.err, e.ratio) } type BetaError struct { err error key string } func (e *BetaError) Error() string { return fmt.Sprintf(\"%v %s\", e.err, e.key) } func (e *BetaError) Unwrap() error { return e.err } type GammaError struct { name string } func (e *GammaError) Error() string { return fmt.Sprintf(\"%s\", e.name) } func main() { err1 := \u0026AlphaError{err: \u0026GammaError{name: \"pollux\"}, ratio: 1} err2 := \u0026BetaError{err: \u0026GammaError{name: \"pollux\"}, key: \"123\"} var ( alphaError *AlphaError betaError *BetaError gammaError *GammaError ) if errors.As(err1, \u0026alphaError) { // true fmt.Println(\"alpha is alpha\") } if errors.As(err1, \u0026gammaError) { // false fmt.Println(\"alpha is gamma\") } if errors.As(err2, \u0026betaError) { // true fmt.Println(\"beta is beta\") } if errors.As(err2, \u0026gammaError) { // true fmt.Println(\"beta is gamma\") } } Never inline errors? Simple cases don’t require to define sentinel values and a simple string is often enough to start with. If later on, you need to match on the error value or type, you can change this to an actual sentinel value.\nThat said, I think any error part of your API should be typed, as you want the lib user to be able to handle it according to its need.\n",
  "wordCount" : "937",
  "inLanguage": "en",
  "datePublished": "2021-05-17T12:30:48+08:00",
  "dateModified": "2021-05-17T12:30:48+08:00",
  "author":{
    "@type": "Person",
    "name": "Me"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://vincentserpoul.github.io/post/go-errors/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "VS tech corner",
    "logo": {
      "@type": "ImageObject",
      "url": "https://vincentserpoul.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://vincentserpoul.github.io/" accesskey="h" title="Home (Alt + H)">Home</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://vincentserpoul.github.io/tags/" title="tags">
                    <span>tags</span>
                </a>
            </li>
            <li>
                <a href="https://vincentserpoul.github.io/" title="vincentserpoul.github.io">
                    <span>vincentserpoul.github.io</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://vincentserpoul.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://vincentserpoul.github.io/post/">Posts</a></div>
    <h1 class="post-title">
      golang errors (after 1.13)
    </h1>
    <div class="post-description">
      golang errors (after 1.13)
    </div>
    <div class="post-meta"><span title='2021-05-17 12:30:48 +0800 +08'>May 17, 2021</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Me

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#what-data-_could_-we-have-in-the-error" aria-label="What data could we have in the error?">What data <em>could</em> we have in the error?</a></li>
                <li>
                    <a href="#where-are-errors-displayed" aria-label="Where are errors displayed?">Where are errors displayed?</a></li>
                <li>
                    <a href="#ways-to-define-errors-after-golang-113" aria-label="Ways to define errors after golang 1.13">Ways to define errors after golang 1.13</a><ul>
                        
                <li>
                    <a href="#a-inline-with-no-type-definition" aria-label="a) inline, with no type definition">a) inline, with no type definition</a></li>
                <li>
                    <a href="#b-sentinel-errors" aria-label="b) sentinel errors">b) sentinel errors</a></li>
                <li>
                    <a href="#c-structs-with-defined-context-and-string-formatting" aria-label="c) structs, with defined context and string formatting">c) structs, with defined context and string formatting</a></li></ul>
                </li>
                <li>
                    <a href="#more-tricks-used-by-libs-out-there" aria-label="More tricks used by libs out there">More tricks used by libs out there</a><ul>
                        
                <li>
                    <a href="#upspinhttpsgithubcomupspinupspinblobmastererrorserrorsgo-by-rob-pike-himself" aria-label="upspin by Rob Pike himself"><a href="https://github.com/upspin/upspin/blob/master/errors/errors.go">upspin</a> by Rob Pike himself</a></li>
                <li>
                    <a href="#big-cachehttpsgithubcomallegrobigcacheblob16762172f2ee433caf5bae1904cdbc11dcebffebiteratorgo" aria-label="big cache"><a href="https://github.com/allegro/bigcache/blob/16762172f2ee433caf5bae1904cdbc11dcebffeb/iterator.go">big cache</a></a></li></ul>
                </li>
                <li>
                    <a href="#so-what-should-we-do" aria-label="So what should we do?">So what should we do?</a><ul>
                        
                <li>
                    <a href="#for-simple-errors" aria-label="For simple errors">For simple errors</a></li>
                <li>
                    <a href="#for-more-complex-errors" aria-label="For more complex errors">For more complex errors</a></li></ul>
                </li>
                <li>
                    <a href="#handling-errors" aria-label="Handling errors">Handling errors</a><ul>
                        
                <li>
                    <a href="#error-as-values" aria-label="Error as values">Error as values</a></li>
                <li>
                    <a href="#error-as-struct" aria-label="Error as struct">Error as struct</a></li></ul>
                </li>
                <li>
                    <a href="#further-thoughts" aria-label="Further thoughts">Further thoughts</a><ul>
                        
                <li>
                    <a href="#panic-or-not-panic" aria-label="Panic or not panic?">Panic or not panic?</a></li>
                <li>
                    <a href="#wrapping-or-not-wrapping" aria-label="Wrapping or not wrapping?">Wrapping or not wrapping?</a></li>
                <li>
                    <a href="#never-inline-errors" aria-label="Never inline errors?">Never inline errors?</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>Since go 1.13, go has gone one step further in terms of error handling. Errors can be wrapped, bubbled up and act upon.</p>
<p>We will here take a step back on error handling in go, from the perspective of a library.</p>
<h2 id="what-data-_could_-we-have-in-the-error">What data <em>could</em> we have in the error?<a hidden class="anchor" aria-hidden="true" href="#what-data-_could_-we-have-in-the-error">#</a></h2>
<p>Inspired by a <a href="https://www.youtube.com/watch?v=rAF8mLI0naQ">rust talk</a> from <a href="https://github.com/yaahc">Jan Lusby</a> about errors, here are a few things that error could contain:</p>
<ul>
<li>The reason of the error</li>
<li>Context of the error: struct field, struct surrounding values&hellip;</li>
<li>Stack trace: which part of the code triggered this error</li>
<li>How to fix the error: suggest a way to fix it</li>
</ul>
<h2 id="where-are-errors-displayed">Where are errors displayed?<a hidden class="anchor" aria-hidden="true" href="#where-are-errors-displayed">#</a></h2>
<ul>
<li>In the logs of an application</li>
<li>In front of the end user</li>
</ul>
<h2 id="ways-to-define-errors-after-golang-113">Ways to define errors after golang 1.13<a hidden class="anchor" aria-hidden="true" href="#ways-to-define-errors-after-golang-113">#</a></h2>
<h3 id="a-inline-with-no-type-definition">a) inline, with no type definition<a hidden class="anchor" aria-hidden="true" href="#a-inline-with-no-type-definition">#</a></h3>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span> <span style="color:#008000;font-weight:bold">return</span> fmt.<span style="color:#00f">Errorf</span>(<span style="color:#ba2121">&#34;bad int %d&#34;</span>, i)
</span></span></code></pre></div><p>(+)</p>
<ul>
<li>simple to write</li>
<li>no runtime penalty</li>
</ul>
<p>(-)</p>
<ul>
<li>impossible to handle properly as you can&rsquo;t match and react accordingly</li>
</ul>
<h3 id="b-sentinel-errors">b) sentinel errors<a hidden class="anchor" aria-hidden="true" href="#b-sentinel-errors">#</a></h3>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">var</span> errBadInt = errors.<span style="color:#00f">New</span>(<span style="color:#ba2121">&#34;bad int&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">return</span> fmt.<span style="color:#00f">Errorf</span>(<span style="color:#ba2121">&#34;%w %d&#34;</span>, i)
</span></span></code></pre></div><p>(+)</p>
<ul>
<li>match on error possible</li>
</ul>
<p>(-)</p>
<ul>
<li>runtime (init) penalty</li>
<li>binary size penalty</li>
<li>global vars (fragile)</li>
</ul>
<h3 id="c-structs-with-defined-context-and-string-formatting">c) structs, with defined context and string formatting<a hidden class="anchor" aria-hidden="true" href="#c-structs-with-defined-context-and-string-formatting">#</a></h3>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">type</span> errBadInt <span style="color:#008000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>   i <span style="color:#b00040">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">func</span> (e <span style="color:#666">*</span>errBadInt) <span style="color:#00f">Error</span>() <span style="color:#b00040">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">return</span> fmt.<span style="color:#00f">Errorf</span>(<span style="color:#ba2121">&#34;bad int: %d&#34;</span>, i)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">func</span> <span style="color:#00f">newErrBadInt</span>(i <span style="color:#b00040">int</span>) <span style="color:#666">*</span>errBadInt {
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">return</span> <span style="color:#666">&amp;</span>errBadInt{i}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="more-tricks-used-by-libs-out-there">More tricks used by libs out there<a hidden class="anchor" aria-hidden="true" href="#more-tricks-used-by-libs-out-there">#</a></h2>
<h3 id="upspinhttpsgithubcomupspinupspinblobmastererrorserrorsgo-by-rob-pike-himself"><a href="https://github.com/upspin/upspin/blob/master/errors/errors.go">upspin</a> by Rob Pike himself<a hidden class="anchor" aria-hidden="true" href="#upspinhttpsgithubcomupspinupspinblobmastererrorserrorsgo-by-rob-pike-himself">#</a></h3>
<ul>
<li>smart use of const and redefine the Error struct with context</li>
<li>return stack in debug mode</li>
</ul>
<h3 id="big-cachehttpsgithubcomallegrobigcacheblob16762172f2ee433caf5bae1904cdbc11dcebffebiteratorgo"><a href="https://github.com/allegro/bigcache/blob/16762172f2ee433caf5bae1904cdbc11dcebffeb/iterator.go">big cache</a><a hidden class="anchor" aria-hidden="true" href="#big-cachehttpsgithubcomallegrobigcacheblob16762172f2ee433caf5bae1904cdbc11dcebffebiteratorgo">#</a></h3>
<ul>
<li>interesting usage of const + error interface to avoid global vars</li>
</ul>
<h2 id="so-what-should-we-do">So what should we do?<a hidden class="anchor" aria-hidden="true" href="#so-what-should-we-do">#</a></h2>
<h3 id="for-simple-errors">For simple errors<a hidden class="anchor" aria-hidden="true" href="#for-simple-errors">#</a></h3>
<p>Keep the errors as they are, but turn them into const thanks to the bigcache trick.
It keeps the nice opportunity to use errors.Is and removes the initialization cost.
No wrapping when there is no additional context.
Context is not stack trace.
Externally available errors should be handling all errors, unwrap them and repackage them again.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">type</span> marshalError <span style="color:#b00040">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">func</span> (me marshalError) <span style="color:#00f">Error</span>() <span style="color:#b00040">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">return</span> <span style="color:#008000">string</span>(me)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">const</span> ErrBadInt = <span style="color:#00f">marshalError</span>(<span style="color:#ba2121">&#34;bad int&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">func</span> <span style="color:#00f">testErr</span>() <span style="color:#b00040">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">return</span> fmt.<span style="color:#00f">Errorf</span>(<span style="color:#ba2121">&#34;%w&#34;</span>, ErrBadInt)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="for-more-complex-errors">For more complex errors<a hidden class="anchor" aria-hidden="true" href="#for-more-complex-errors">#</a></h3>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">type</span> badValueError <span style="color:#008000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>key   <span style="color:#b00040">string</span>
</span></span><span style="display:flex;"><span>value <span style="color:#008000;font-weight:bold">interface</span>{}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">func</span> (bv <span style="color:#666">*</span>badValueError) <span style="color:#00f">Error</span>() <span style="color:#b00040">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">return</span> fmt.<span style="color:#00f">Sprintf</span>(<span style="color:#ba2121">&#34;bad value %v for key %s&#34;</span>, bv.value, bv.key)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">func</span> <span style="color:#00f">testErr</span>() <span style="color:#b00040">error</span> {
</span></span><span style="display:flex;"><span>	v <span style="color:#666">:=</span> <span style="color:#666">3</span>
</span></span><span style="display:flex;"><span>	k <span style="color:#666">:=</span> <span style="color:#ba2121">&#34;test&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">return</span> badValueError{key: k, value: v}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="handling-errors">Handling errors<a hidden class="anchor" aria-hidden="true" href="#handling-errors">#</a></h2>
<h3 id="error-as-values">Error as values<a hidden class="anchor" aria-hidden="true" href="#error-as-values">#</a></h3>
<p><a href="https://play.golang.org/p/gzCFQLfaGdL">testable in the playground</a></p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#ba2121">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ba2121">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ba2121">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">type</span> marshalError <span style="color:#b00040">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">func</span> (me marshalError) <span style="color:#00f">Error</span>() <span style="color:#b00040">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">return</span> <span style="color:#008000">string</span>(me)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">const</span> errBadInt = <span style="color:#00f">marshalError</span>(<span style="color:#ba2121">&#34;bad int&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">func</span> <span style="color:#00f">testErr</span>() <span style="color:#b00040">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">return</span> fmt.<span style="color:#00f">Errorf</span>(<span style="color:#ba2121">&#34;%w&#34;</span>, errBadInt)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">func</span> <span style="color:#00f">main</span>() {
</span></span><span style="display:flex;"><span>	err <span style="color:#666">:=</span> <span style="color:#00f">testErr</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">if</span> errors.<span style="color:#00f">Is</span>(err, errBadInt) {
</span></span><span style="display:flex;"><span>		log.<span style="color:#00f">Printf</span>(<span style="color:#ba2121">&#34;%v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	} <span style="color:#008000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#00f">Println</span>(<span style="color:#ba2121">&#34;wrong&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">var</span> e marshalError
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">if</span> errors.<span style="color:#00f">As</span>(err, <span style="color:#666">&amp;</span>e) {
</span></span><span style="display:flex;"><span>		log.<span style="color:#00f">Printf</span>(<span style="color:#ba2121">&#34;%v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	} <span style="color:#008000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#00f">Println</span>(<span style="color:#ba2121">&#34;wrong&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="error-as-struct">Error as struct<a hidden class="anchor" aria-hidden="true" href="#error-as-struct">#</a></h3>
<p><a href="https://play.golang.org/p/XE7L2KWf3Au">on the playground</a></p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#ba2121">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ba2121">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ba2121">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">type</span> badValueError <span style="color:#008000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	key   <span style="color:#b00040">string</span>
</span></span><span style="display:flex;"><span>	value <span style="color:#008000;font-weight:bold">interface</span>{}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">func</span> (bv <span style="color:#666">*</span>badValueError) <span style="color:#00f">Error</span>() <span style="color:#b00040">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">return</span> fmt.<span style="color:#00f">Sprintf</span>(<span style="color:#ba2121">&#34;bad value %v for key %s&#34;</span>, bv.value, bv.key)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">func</span> <span style="color:#00f">testErr</span>() <span style="color:#b00040">error</span> {
</span></span><span style="display:flex;"><span>	v <span style="color:#666">:=</span> <span style="color:#666">3</span>
</span></span><span style="display:flex;"><span>	k <span style="color:#666">:=</span> <span style="color:#ba2121">&#34;test&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#008000;font-weight:bold">return</span> <span style="color:#666">&amp;</span>badValueError{key: k, value: v}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">func</span> <span style="color:#00f">main</span>() {
</span></span><span style="display:flex;"><span>	err <span style="color:#666">:=</span> <span style="color:#00f">testErr</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">var</span> e <span style="color:#666">*</span>badValueError
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">if</span> errors.<span style="color:#00f">As</span>(err, <span style="color:#666">&amp;</span>e) {
</span></span><span style="display:flex;"><span>		log.<span style="color:#00f">Printf</span>(<span style="color:#ba2121">&#34;%v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	} <span style="color:#008000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#00f">Println</span>(<span style="color:#ba2121">&#34;wrong&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="further-thoughts">Further thoughts<a hidden class="anchor" aria-hidden="true" href="#further-thoughts">#</a></h2>
<h3 id="panic-or-not-panic">Panic or not panic?<a hidden class="anchor" aria-hidden="true" href="#panic-or-not-panic">#</a></h3>
<p>I tend to agree with <a href="https://github.com/uber-go/guide/blob/master/style.md">uber recommendation</a> to not panic in a library, especially when you&rsquo;re expected to most likely handle user data. It allows the user of the lib to do whatever they want with the returned error.</p>
<p>That said, it&rsquo;s important to actually notify the library user if the library is used improperly in cases that are supposedly &ldquo;not possible&rdquo; by panicking.
The lib user is always able to handle these panics through a recover.</p>
<h3 id="wrapping-or-not-wrapping">Wrapping or not wrapping?<a hidden class="anchor" aria-hidden="true" href="#wrapping-or-not-wrapping">#</a></h3>
<p>from <a href="https://blog.golang.org/go1.13-errors#TOC_3.4.">go1.13 post on errors</a>:</p>
<pre><code>&quot;wrapping an error makes that error part of your API. If you don't want to commit to supporting that error as part of your API in the future, you shouldn't wrap the error.&quot;
</code></pre>
<p>It also makes no sense to wrap unexported errors to the external user of the API, as the user has no way of testing/matching the error.
External methods hence should not return internal errors and return their own exported type, catered at the lib user.</p>
<p><a href="https://go.dev/play/p/eMVNaeGV5QM">See what wrapping allow and not allow you to do</a>:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#ba2121">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ba2121">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">type</span> AlphaError <span style="color:#008000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	err   <span style="color:#b00040">error</span>
</span></span><span style="display:flex;"><span>	ratio <span style="color:#b00040">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">func</span> (e <span style="color:#666">*</span>AlphaError) <span style="color:#00f">Error</span>() <span style="color:#b00040">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">return</span> fmt.<span style="color:#00f">Sprintf</span>(<span style="color:#ba2121">&#34;%v %d&#34;</span>, e.err, e.ratio)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">type</span> BetaError <span style="color:#008000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	err <span style="color:#b00040">error</span>
</span></span><span style="display:flex;"><span>	key <span style="color:#b00040">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">func</span> (e <span style="color:#666">*</span>BetaError) <span style="color:#00f">Error</span>() <span style="color:#b00040">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">return</span> fmt.<span style="color:#00f">Sprintf</span>(<span style="color:#ba2121">&#34;%v %s&#34;</span>, e.err, e.key)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">func</span> (e <span style="color:#666">*</span>BetaError) <span style="color:#00f">Unwrap</span>() <span style="color:#b00040">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">return</span> e.err
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">type</span> GammaError <span style="color:#008000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	name <span style="color:#b00040">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">func</span> (e <span style="color:#666">*</span>GammaError) <span style="color:#00f">Error</span>() <span style="color:#b00040">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">return</span> fmt.<span style="color:#00f">Sprintf</span>(<span style="color:#ba2121">&#34;%s&#34;</span>, e.name)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">func</span> <span style="color:#00f">main</span>() {
</span></span><span style="display:flex;"><span>	err1 <span style="color:#666">:=</span> <span style="color:#666">&amp;</span>AlphaError{err: <span style="color:#666">&amp;</span>GammaError{name: <span style="color:#ba2121">&#34;pollux&#34;</span>}, ratio: <span style="color:#666">1</span>}
</span></span><span style="display:flex;"><span>	err2 <span style="color:#666">:=</span> <span style="color:#666">&amp;</span>BetaError{err: <span style="color:#666">&amp;</span>GammaError{name: <span style="color:#ba2121">&#34;pollux&#34;</span>}, key: <span style="color:#ba2121">&#34;123&#34;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">var</span> (
</span></span><span style="display:flex;"><span>		alphaError <span style="color:#666">*</span>AlphaError
</span></span><span style="display:flex;"><span>		betaError  <span style="color:#666">*</span>BetaError
</span></span><span style="display:flex;"><span>		gammaError <span style="color:#666">*</span>GammaError
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">if</span> errors.<span style="color:#00f">As</span>(err1, <span style="color:#666">&amp;</span>alphaError) { <span style="color:#408080;font-style:italic">// true
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span>		fmt.<span style="color:#00f">Println</span>(<span style="color:#ba2121">&#34;alpha is alpha&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">if</span> errors.<span style="color:#00f">As</span>(err1, <span style="color:#666">&amp;</span>gammaError) { <span style="color:#408080;font-style:italic">// false
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span>		fmt.<span style="color:#00f">Println</span>(<span style="color:#ba2121">&#34;alpha is gamma&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">if</span> errors.<span style="color:#00f">As</span>(err2, <span style="color:#666">&amp;</span>betaError) { <span style="color:#408080;font-style:italic">// true
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span>		fmt.<span style="color:#00f">Println</span>(<span style="color:#ba2121">&#34;beta is beta&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#008000;font-weight:bold">if</span> errors.<span style="color:#00f">As</span>(err2, <span style="color:#666">&amp;</span>gammaError) { <span style="color:#408080;font-style:italic">// true
</span></span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"></span>		fmt.<span style="color:#00f">Println</span>(<span style="color:#ba2121">&#34;beta is gamma&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="never-inline-errors">Never inline errors?<a hidden class="anchor" aria-hidden="true" href="#never-inline-errors">#</a></h3>
<p>Simple cases don&rsquo;t require to define sentinel values and a simple string is often enough to start with.
If later on, you need to match on the error value or type, you can change this to an actual sentinel value.</p>
<p>That said, I think any error part of your API should be typed, as you want the lib user to be able to handle it according to its need.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://vincentserpoul.github.io/tags/golang/">golang</a></li>
      <li><a href="https://vincentserpoul.github.io/tags/errors/">errors</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://vincentserpoul.github.io/post/rust-optimized-container/">
    <span class="title">« Prev Page</span>
    <br>
    <span>deploying rust in containers</span>
  </a>
  <a class="next" href="https://vincentserpoul.github.io/post/stable-coins/">
    <span class="title">Next Page »</span>
    <br>
    <span>The stable coins</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://vincentserpoul.github.io/">VS tech corner</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
